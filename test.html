<!DOCTYPE html>
<html>
<head>
	<title></title>
</head>
<body>
//--------------------------------------------------------------------
// Scénario      : Std_AffDesMachine
// Cree le       : 
// Déclenchement : Code Barre Opérateur (Clavier ou Code à Barre)
// Contenu       : Ce scénario permet a un opérateur de s'affecter ou
//      de se désaffecter d'une machine.
//--------------------------------------------------------------------

With
   TCL_Utilitaires,
   Std_Enregistrement,
   Std_GestionPresence,
   Std_TypeTraca,
   Std_LectureTraca,
UN_REPORTING_TMP;

Procedure UN_AffDesMaRes_TR;

Var
   Req                  : TresGrandeChaine;

   Rep                  : T_ReponseSQL;

   CleBDDDesiScenario,
   Scenario,
   CodeBadg,
   MatrOld,
   MessageFin1,
   MessageFin2,
   Param,
   MatrPers,
   NomPers,
   PrePers,
   BadgePers,
Valeur                 : PetiteChaine;
TempsFormate,
NomMachine,
CodeSiteMachine         : GrandeChaine;

   NombActi,
   NombOper,
   DateActuelle,
   NumeTerminal,
   DeltaHeureUTC,
   NombRepo,
   DateDebuProd,
Term ,
Nombre,
NombReponseEVT,
NombRepoPer        : Integer;
  
   TScenario         : T_SCENARIO;
   PersonnelOld,
   Personnel         : T_PERSONNEL;
   Terminal            : T_TERMINAL;
   Machine            : T_MACHINE;
   EtatPersonnel      : T_ETAT_PERSO;
   EvtProduction      : T_EVT_PRODUCTION_EC;
   Site              : T_SITE;

   Debug,
   DejaAffecte,
   Fermeture,
   ProductionEnCours,
   Test ,
   FinSaisie,
Autorise,
MachineVide                 : Boolean;

Begin

   //---- Variable de Debug
   Debug:=False;
  Autorise:=False;   
MachineVide :=False;                              
   Param := LitParam(1);
   //---- Lecture du Terminal courant et du reste du message reseau   


EcritMessageErreur("Lecture du Terminal courant et du reste du message reseau   ");
   NumeTerminal:=Val(LitMemoire("Terminal"));
   CodeBadg:=LitMemoire("Message action");   
   PositionneVerrouSaisie(NumeTerminal);
   //---- Initialisation des parametres du scénario
//   Test:=LitScenario("STDAFFDESMACHINE", TScenario);
   Test:=LitScenario("UN_AffDesMaRes_TR", TScenario);
//   Scenario:=TScenario.SCENDesiScen;
   CleBDDDesiScenario:=TScenario.SCENDesiScen;
   Scenario := TraduireCleDesiBDD(CleBDDDesiScenario,GetMessage("LANGUAGE_USED",""));

   DateActuelle:=TempsSysteme; 

   //---- Lecture des informations du Terminal
   Test:=LitTerminal(NumeTerminal,Terminal);
   If Test=False Then
      ErreurFatale(Terminal,GetMessage("S_GENE_TERM_1",""),"",GetMessage("S_GENE_TERM_3",""),GetMessage("S_GENE_TERM_4",""));
   End If;

   //---- lecture des donnees du site associes au terminal
   Test := LitSite(Terminal.TERCodeSite, Site);

   //--- Calcul du decalage
   DeltaHeureUTC:=DecalageUTC(Site.SITZoneUTC,Site.SITFlagHeurEte);

   //---- Sélection éventuelle de la machine
   Machine.MACCodeMach:="";
   If Terminal.TERFlagMultMach=Oui Then
      //---- Selection de la machine
      Test:=SelectionMachine(Terminal,Machine.MACCodeMach);
   End If;

   //---- Lecture des informations de la Machine
   Test:=LitMachine(Terminal.TERCodeTerm,Machine.MACCodeMach,Machine,True);
   If Test=False Then
      ErreurFatale(Terminal,Scenario,GetMessage("S_GENE_TERMCONN_1",""),GetMessage("S_GENE_TERMCONN_2",""),GetMessage("S_GENE_TERMCONN_3",""));
   End If;

EcritMessageErreur("C'est la machine choisier -----------------> :"+Machine.MACCodeMach);
EcritMessageErreur("C'est la machine choisier Machine.MACCodeSite -----------------> :"+Machine.MACCodeSite);
NomMachine:=Machine.MACCodeMach;
CodeSiteMachine:=Machine.MACCodeSite;





 //--- Saisie des badges operateurs 
 FinSaisie := False;
 Repeat
  CodeBadg:="";
  While(CodeBadg="") Do
   //---- Détection si le déclenchement n'est pas un badge operateur
   If (VerifieEnTete(CodeBadg,LitConstanteSite("EnTeteCodeBadg",Site.SITIndice),False)=False) Or (LitConstanteSite("EnTeteCodeBadg",Site.SITIndice)="") Then
      //---- Saisie de la cause de rebut
      SaisieTerminal(Terminal,Scenario,
             "VOTRE BADGE (F3=FIN) ?",GetMessage("S_GENE_BADG5_1",""),GetMessage("S_GENE_BADG5_2",""),CodeBadg);
         

   End If;
   If(CodeBadg="c") Then
      FinSaisie:=True;
   Else

   //---- Vérification de l'Entête du Badge de la personne
   If Not VerifieEnTete(CodeBadg,LitConstanteSite("EnTeteCodeBadg",Site.SITIndice),True) Then
      EcritMessageTempo(Terminal,GetMessage("S_GENE_BADG2_1",""),"",GetMessage("S_GENE_BADG2_3",""),GetMessage("S_GENE_BADG2_4",""));
      CodeBadg:="";
   End If;











//// verifier c'est l'operateur est autoriser sur le terminal 

       Req:="select CODE_TERM from MACHINE  where CODE_MACH=(select CODE_MACH from HABILITATION_MACH where MATR=(select MATR from PERSONNEL where CODE_BADG='"+CodeBadg+"'))";
       Rep:=ExecuteRequeteSQL(Req);
       Term :=Val(ValeurChamp(Rep,1,1)); 
       Fermeture:=FermeReponseSQL(Rep);



//If Term =NumeTerminal Then
      

/// controle si la personne existe
//Req:="select CODE_MACH from EVT_PERSONNEL_EC where MATR=(select MATR from PERSONNEL where CODE_BADG ='"+CodeBadg+"')";
    //   Rep:=ExecuteRequeteSQL(Req);
  //     Machine.MACCodeMach:=ValeurChamp(Rep,1,1);
//Nombre :=NombreReponseSQL(Rep);
  //     Fermeture:=FermeReponseSQL(Rep);

//If Nombre = 0 Then
////////////////////////Recupere l'UO de l'operateur
//Req:="select CODE_MACH from HABILITATION_MACH where MATR=(select MATR from PERSONNEL where CODE_BADG ='"+CodeBadg+"')";
    //   Rep:=ExecuteRequeteSQL(Req);
     //  Machine.MACCodeMach:=ValeurChamp(Rep,1,1);
  ///  Recuperation de nom machine-----

  //     Fermeture:=FermeReponseSQL(Rep);
//End If;
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

//Req:="select CODE_MACH from EVT_PERSONNEL_EC where MATR=(select MATR from PERSONNEL where CODE_BADG ='"+CodeBadg+"')";
//Rep:=ExecuteRequeteSQL(Req);
  // NomMachine:=ValeurChamp(Rep,1,1);
//Fermeture:=FermeReponseSQL(Rep);
//EcritMessageErreur("Nom de la machine ------------------------> "+NomMachine);

//If(NomMachine="-")Then
//MachineVide:=True;                 
//Else
//MachineVide:=False; 
//End If;
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////:

//-------------------------------------------------------------------
   //---- on verifier si la personne déja affectée sur une machine pour ne pas descend le pointage
   //-------------------------------------------------------------------

               Req:="select MATR from EVT_PERSONNEL_EC WHERE CODE_MACH !='-' AND MATR=(select MATR from PERSONNEL where CODE_BADG ='"+CodeBadg+"')";
               Rep:=ExecuteRequeteSQL(Req);
               NombReponseEVT:=NombreReponseSQL(Rep);

               Fermeture:=FermeReponseSQL(Rep);








//-----------------------------------------------------------------------------------------







   //---- Recherche des informations sur la personne
   Test:=LitPersonnelBadge(CodeBadg,Personnel,True,Terminal);
   If Test=False Then
      EcritMessageTempo(Terminal,GetMessage("S_GENE_BADG3_1",CodeBadg),"",GetMessage("S_GENE_BADG3_3",CodeBadg),GetMessage("S_GENE_BADG3_4",""));
      CodeBadg:="";
   End If;

   //---- Erreur si le badge de la personnel est bloqué
   If Personnel.PERFlagBadgBloq=Oui Then
      EcritMessageTempo(Terminal,GetMessage("S_GENE_BADG4_1",CodeBadg),"",GetMessage("S_GENE_BADG4_3",CodeBadg),GetMessage("S_GENE_BADG4_4",""));
      CodeBadg:="";
   End If;

   //---- On vérifie si le Code_Site de la personne correspond à celui du terminal.
   If Personnel.PERCodeSite <> Terminal.TERCodeSite Then
      EcritMessageTempo(Terminal,GetMessage("S_GENE_BADG3_1",CodeBadg),"",GetMessage("S_GENE_BADG3_3",CodeBadg),GetMessage("S_GENE_BADG3_4",""));
      CodeBadg:="";
   End If;


   //---- On recherche si la personne est déjà affectée sur la machine
   Req:="SELECT DISTINCT MATR FROM EVT_PERSONNEL_EC "+
        "WHERE CODE_MACH="+StrqBD(Machine.MACCodeMach)+
        " AND CODE_TACH="+StrqBD(CodeTachProd)+
        " AND MATR="+StrqBD(Personnel.PERMatr);
   Rep:=ExecuteRequeteSQL(Req);
   If NombreReponseSQL(Rep)>0 Then
      DejaAffecte:=True;
   Else
      DejaAffecte:=False;
   End If;
   Fermeture:=FermeReponseSQL(Rep);  

   //--- Debug
   If Debug Then
      If DejaAffecte Then
         EcritMessageErreur("Desaffectation de "+Personnel.PERMatr+" sur "+Machine.MACCodeMach);
      Else
         EcritMessageErreur("Affectation de "+Personnel.PERMatr+" sur "+Machine.MACCodeMach);
      End If;
   End If;
   //-------------------------------------------------------------------
   //---- GESTION POINTAGE TROP PROCHE EN CAS DE DESAFFECTATION 
   //-------------------------------------------------------------------
   DateDebuProd  :=0;
   If ((DejaAffecte=True) And (Param <>"R")) Then
         Req:="SELECT DATE_DEBU_AFFE "+
              " FROM EVT_PERSONNEL_EC "+
              "WHERE CODE_MACH="+StrqBD(Machine.MACCodeMach)+
              " AND MATR="+StrqBD(Personnel.PERMatr);
         Rep:=ExecuteRequeteSQL(Req);
         DateDebuProd :=DeFormaterTempsBDUTC( ValeurChamp(Rep,1,1));
         EcritMessageErreur (ValeurChamp(Rep,1,1));
         Fermeture:=FermeReponseSQL(Rep); 
DateActuelle:=TempsSysteme; 
         If DateActuelle-DateDebuProd <=Val(LitConstanteSite("TempPointProche",Site.SITIndice)) Then
//EcritMessageErreur("DateActuelle :"+Str(DateActuelle));
//EcritMessageErreur("DateDebuProd :"+Str(DateDebuProd ));
//EcritMessageErreur("Resultat :"+Str(DateActuelle-DateDebuProd));
            EcritMessageTempo(Terminal,Scenario,"POINTAGE TROP PROCHE  !!!!","","");
            CodeBadg:="";
         End If;
   End If;


//---- Controle de l'habilitation machine en cas de non affecté
   If ((DejaAffecte=False) And (Machine.MACFlagHabi=Oui) And (Param <>"R")) Then

         //---- Recherche de l'habilitation de la personne
         If Not VerifieHabilitationMachine(Machine.MACCodeMach,Personnel.PERMatr) Then
            EcritMessageTempo(Terminal,Scenario,Personnel.PERNom+" "+Personnel.PERPren+ " NON HABILITE !","","");
            CodeBadg:="";
         End If;

   End If;


   //---- Lecture de l'évènement production en cours de la Machine
   ProductionEnCours:=LitEvtProduction(Machine.MACCodeMach,CodeTachProd,EvtProduction);

   //---- Si un OF est déjà en cours sur la Machine INTERDIT
   If (Not ProductionEnCours) And (Not DejaAffecte) And (LitConstanteSite("FlagAffectHorsProd",Site.SITIndice)<>Oui) Then
      EcritMessageTempo(Terminal,Scenario,GetMessage("S_GENE_ERREPROD1_1",""),GetMessage("S_GENE_ERREPROD1_2",""),GetMessage("S_GENE_ERREPROD1_3",""));
      CodeBadg:="";
   End If;

   

   //---- Recherche du nombre d'activite de la personne
   Req:="SELECT DISTINCT CODE_MACH FROM EVT_PERSONNEL_EC "+
        "WHERE CODE_TACH="+StrqBD(CodeTachProd)+
        " AND MATR="+StrqBD(Personnel.PERMatr);
   Rep:=ExecuteRequeteSQL(Req);
   NombActi:=NombreReponseSQL(Rep);
   Fermeture:=FermeReponseSQL(Rep);  

   //---- Controle de la limite du nombre d'activite en cours
   If (DejaAffecte=False) And (Personnel.PERNombActiMaxi>1) Then

      //---- Erreur si dépassement de la limite
      If Personnel.PERNombActiMaxi<=NombActi Then
         EcritMessageTempo(Terminal,GetMessage("S_GENE_ACTIEC_1",Str(NombActi)),"",
                GetMessage("S_GENE_ACTIEC_3",Str(NombActi)),GetMessage("S_GENE_ACTIEC_4",Str(NombActi)));
         CodeBadg:="";
      End If;

   End If;

   //---- On recherche le nombre d'opérateur affecté sur la machine
   Req:="SELECT DISTINCT MATR FROM EVT_PERSONNEL_EC "+
        "WHERE CODE_MACH="+StrqBD(Machine.MACCodeMach)+
        " AND CODE_TACH="+StrqBD(CodeTachProd);
   Rep:=ExecuteRequeteSQL(Req);
   NombOper:=NombreReponseSQL(Rep);

   //---- On vérifie que le nombre maxi d'opérateur sur la machine n'est pas dépassé
   //---- Uniquement dans le cas d'une affectation
   If DejaAffecte=False Then

      //---- Contrôle par rapport au nombre maximum d'opérateur sur le poste
      If (Machine.MACNombOperMaxi>1) Then

         //---- Si le nombre est dépassé on arrete le scénario
         If (NombOper>=Machine.MACNombOperMaxi) Then
            EcritMessageTempo(Terminal,GetMessage("S_GENE_AFFPERSMAX_1",""),
                GetMessage("S_GENE_AFFPERSMAX_2",Str(Machine.MACNombOperMaxi)),
                GetMessage("S_GENE_AFFPERSMAX_3",Str(Machine.MACNombOperMaxi)),GetMessage("S_GENE_AFFPERSMAX_4",""));
            CodeBadg:="";
         End If;

      //---- Sinon récupération du Matricule de l'autre Opérateur
      ElsIf NombOper=1 Then

         //---- Récupération de la fiche personnel de l'autre opérateur
         MatrOld:=ValeurChamp(Rep,1,1);
         Test:=LitPersonnel(MatrOld,PersonnelOld,True,Terminal);

      End If;

   End If;

   //Fermeture:=FermeReponseSQL(Rep);
 // End If;







Fermeture:=FermeReponseSQL(Rep);


Autorise:=True;


//Else 
//      EcritMessageTempo(Terminal,Scenario,"vous n'êtes pas autorisé sur le terminal !!!!"+CodeBadg,"","");
//Autorise:=False;

//End If;

  End If;






  End While;


















  If(FinSaisie =False) Then
   //---------------------------------------------------------------
   //   DEBUT DES ENREGISTREMENTS
   //---------------------------------------------------------------
   PositionneVerrouEnreg(NumeTerminal);
   DateActuelle:=TempsSysteme;

   //---- Gestion de la présence de la personne
   Personnel.PerDateDernPoin:=DateActuelle;

   //---- Dans le cas ou la personne est déjà affectée, on la desaffecte
   //----     1) on historise tous les évènements en cours
   //----     2) on supprime ses activités productives en cours sur la machine
   //----     3) on mets a jour le nombre d'activité dans les fiches affectation restante
   If DejaAffecte=True Then

     //--- Debug
      If Debug Then
         EcritMessageErreur("Desaffectation "+Personnel.PERMatr+" sur "+Machine.MACCodeMach);
      End If;

    //--- Calcul du decalage
       DeltaHeureUTC:=DecalageUTC(Site.SITZoneUTC,Site.SITFlagHeurEte);
    //---- Si la personne a des activites en cours, on les supprime
       Req:="SELECT COUNT(*) FROM EVT_PERSONNEL_EC "+
              "WHERE MATR="+StrqBD(Personnel.PerMatr);
       Rep:=ExecuteRequeteSQL(Req);
       NombRepo:=Val(ValeurChamp(Rep,1,1));
       Fermeture:=FermeReponseSQL(Rep);
       If NombRepo>0 Then

      //---- On historise tous les évènements de la personne en cours
         HistoriseEvtPersonnelMatr(Personnel,DeltaHeureUTC,DateActuelle);

      //---- Suppression de toutes les activités en cours de la personne
         Req:="DELETE FROM EVT_PERSONNEL_EC "+
              "WHERE MATR="+StrqBD(Personnel.PERMatr);
         Rep:=ExecuteRequeteSQL(Req);
         Fermeture:=FermeReponseSQL(Rep);

         End If;   

   //---> Modification PETITOT du 13/04/2012 : utilisation de la fonction de depart selon 
   //     le mode de gestion des evenements presences (automatique ou non)    
         If LitConstanteSite("FlagGestPresenceAuto",Site.SITIndice)=Oui Then
            //Appel d'une fonction differentes gérant la presence automatique du personnel : JB 15 Mars 2012
            DepartPersonnelOptima(Personnel,Site.SITIndice,DateActuelle,DeltaHeureUTC,ChamCleVide,Terminal);
         Else
            DepartPersonnel(Personnel,Site.SITIndice,DateActuelle,DeltaHeureUTC,ChamCleVide,Terminal);
         End If;



      //---- Message de fin du scénario
      MessageFin1:=GetMessage("S_GENE_MESSFINDESAFF_1",Machine.MACCodeMachSite);
      MessageFin2:=GetMessage("S_GENE_MESSFINDESAFF_2","");


   //---- Dans le cas ou la personne s'affecte sur la machine
   //----     1) on historise tous les évènements en cours
   //----     2) on arrete toutes ses activités non productives
   //----     3) on recherche le nombre d'affectation machine en cours
   //----     4) on créé les en cours personnel pour les OFs en cours sur la machine
   Else

      //---- On historise tous les évènements de la personne en cours
      HistoriseEvtPersonnelMatr(Personnel,DeltaHeureUTC,DateActuelle);

      //---- Suppression de toutes les activités en cours de la personne
      Req:="DELETE FROM EVT_PERSONNEL_EC "+
           "WHERE MATR="+StrqBD(Personnel.PERMatr)+
           " AND CODE_TACH<>"+StrqBD(CodeTachProd);
      Rep:=ExecuteRequeteSQL(Req);
      Fermeture:=FermeReponseSQL(Rep);

      //---- On recherche si la personne possède encore des activités sur des machines
      Req:="SELECT DISTINCT CODE_MACH FROM EVT_PERSONNEL_EC "+
           "WHERE CODE_TACH="+StrqBD(CodeTachProd)+
           " AND MATR="+StrqBD(Personnel.PERMatr);
      Rep:=ExecuteRequeteSQL(Req);
      NombActi:=NombreReponseSQL(Rep);
      Fermeture:=FermeReponseSQL(Rep);

      //---- Gestion des autres activités de la personne sur la machine
      If NombActi>0 Then
         
         //---- Si la personne démarre une nouvelle activité
         If (Personnel.PERNombActiMaxi>1) Then

            //----- Mise à jour des coefficients des évènements restants
            Req:="UPDATE EVT_PERSONNEL_EC "+
                 "SET DATE_DEBU_PERS="+FormaterTempsBDUTC(DateActuelle)+
                  ",DELT_HEUR_UTC="+Str(DeltaHeureUTC)+
                 ",COEF=COEF*"+Str(NombActi+1)+"/"+Str(NombActi)+
                 " WHERE CODE_TACH="+StrqBD(CodeTachProd)+
                 " AND MATR="+StrqBD(Personnel.PERMatr);
            Rep:=ExecuteRequeteSQL(Req);
            Fermeture:=FermeReponseSQL(Rep);

         //---- Sinon on arrête son activité précédente
         Else

            //---- Suppression de toutes les activités en cours de la personne
            Req:="DELETE FROM EVT_PERSONNEL_EC "+
                 "WHERE MATR="+StrqBD(Personnel.PERMatr)+
                 " AND CODE_TACH="+StrqBD(CodeTachProd);
            Rep:=ExecuteRequeteSQL(Req);
            Fermeture:=FermeReponseSQL(Rep);
            NombActi:=0;

         End If;

      End If;

      //---- Gestion de la désaffectation des autres personnes de la machine
      If (NombOper>0) And (Machine.MACNombOperMaxi=1) Then
         
         //---- On historise tous les évènements de la personne en cours
         HistoriseEvtPersonnelMatr(PersonnelOld,DeltaHeureUTC,DateActuelle);

      

         //---- Suppression de toutes les activités en cours de la personne
         Req:="DELETE FROM EVT_PERSONNEL_EC "+
              "WHERE MATR="+StrqBD(PersonnelOld.PERMatr)+
              " AND CODE_TACH="+StrqBD(CodeTachProd)+
              " AND CODE_MACH="+StrqBD(Machine.MACCodeMach);
         Rep:=ExecuteRequeteSQL(Req);
         Fermeture:=FermeReponseSQL(Rep);

         //---- On recherche si la personne possède encore des activités sur des machines
         Req:="SELECT DISTINCT CODE_MACH FROM EVT_PERSONNEL_EC "+
              "WHERE CODE_TACH="+StrqBD(CodeTachProd)+
              " AND MATR="+StrqBD(PersonnelOld.PERMatr);
         Rep:=ExecuteRequeteSQL(Req);
         NombActi:=NombreReponseSQL(Rep);
         Fermeture:=FermeReponseSQL(Rep);

         //---- Si la personne a encore des activités machine, on modifie les coefficients
         //----    de répartition de ces évènements
         If NombActi>0 Then
         
            //---- Mise à jour des coefficients des évènements restants
            Req:="UPDATE EVT_PERSONNEL_EC "+
                 "SET DATE_DEBU_PERS="+FormaterTempsBDUTC(DateActuelle)+
                  ",DELT_HEUR_UTC="+Str(DeltaHeureUTC)+
                 ",COEF=COEF*"+Str(NombActi)+"/"+Str(NombActi+1)+
                 " WHERE CODE_TACH="+StrqBD(CodeTachProd)+
                 " AND MATR="+StrqBD(PersonnelOld.PERMatr);
            Rep:=ExecuteRequeteSQL(Req);
            Fermeture:=FermeReponseSQL(Rep);

         //---- si dernière activité machine de la personne
         Else

            //---- Si le paramétrage demande le suivi des activités inter activités des personnes
            //----     et que l'on suit les pointages de la personne
            If (LitConstanteSite("FlagSuiviInterActiv",Site.SITIndice)=Oui) And
                   (PersonnelOld.PERFlagSuivPoin=Oui) Then

               //---- Création des activités intermédiaires de la personne
               CreeEvtPersInterActivite(Terminal,PersonnelOld,Site.SITIndice,DeltaHeureUTC,DateActuelle);

            End If;

         End If;

      End If;

      //---- Détermination de la section Analytique
      Test:=LitEtatPersonnel(LitConstanteSite("EtatProduction",Site.SITIndice),EtatPersonnel);
      If EtatPersonnel.ETPCodeSectAnal<>ChamCleVide Then
         Machine.MACCodeSectAnal:=EtatPersonnel.ETPCodeSectAnal;
      End If;









      //---- Si il y a une production en cours on affecte la personne sur les OFs actifs
      If ProductionEnCours Then

         //---- Création des évènements Machine en Cours pour chaque Article saisi de l'OF
         Req:="INSERT INTO EVT_PERSONNEL_EC (MATR,CODE_TERM,CODE_MACH,CODE_OF,CODE_OPER,"+
                 "CODE_TACH,CODE_ARTI,DATE_DEBU_PERS,DATE_DEBU_PROD,COEF_QUAN_UNIT,CODE_ETAT_PERS,COEF,"+
                 "QUAN_BONN,QUAN_REBU,DATE_CALE,CODE_EQUI,DATE_CALE_OPER,CODE_EQUI_OPER,DATE_DEBU_AFFE,CADE_THEO,CODE_SECT_ANAL,"+
                 "CODE_SECT_GEOG,CODE_ATEL,CODE_SITE,"+
                 "DELT_HEUR_UTC,CODE_LOCA_PERS,CODE_NOEU_PERS,CODE_LOCA_MACH,CODE_NOEU_MACH) "+
              "SELECT "+StrqBD(Personnel.PERMatr)+
                 ","+Str(Terminal.TERCodeTerm)+
                 ",CODE_MACH,CODE_OF,CODE_OPER"+
                 ","+StrqBD(CodeTachProd)+
                 ",CODE_ARTI"+
                 ","+FormaterTempsBDUTC(DateActuelle)+
                 ",DATE_DEBU_PROD"+
                 ",COEF_QUAN_UNIT"+
                 ","+StrqBD(LitConstanteSite("EtatProduction",Site.SITIndice))+
                 ",COEF*"+Str(NombActi+1)+
                 ",0,0"+
                 ",DATE_CALE,CODE_EQUI"+
                 ","+FormaterTempsBDOLD(Personnel.PERDateCale)+
                 ","+StrqBD(Personnel.PERCodeEqui)+
                 ","+FormaterTempsBDUTC(DateActuelle)+
                 ",CADE_THEO"+
                 ","+StrqBD(Machine.MACCodeSectAnal)+
                 ","+StrqBD(Machine.MACCodeSectGeog)+
                 ","+StrqBD(Machine.MACCodeAtel)+
                 ",CODE_SITE"+
                 ","+Str(DeltaHeureUTC)+
                 ","+StrqBD(Personnel.PERCodeLocaPers)+
                 ","+StrqBD(Personnel.PERCodeNoeuPers)+
                 ","+StrqBD(Machine.MACCodeLocaMach)+
                 ","+StrqBD(Machine.MACCodeNoeuMach)+
              " FROM EVT_PRODUCTION_EC "+
              " WHERE CODE_MACH="+StrqBD(Machine.MACCodeMach)+
              " AND CODE_TACH="+StrqBD(CodeTachProd);
         Rep:=ExecuteRequeteSQL(Req);
         Fermeture:=FermeReponseSQL(Rep);






      //---- Si il n'y a pas de production en cours
      Else

         //---- Création des évènements Machine en Cours pour chaque Article saisi de l'OF
         Req:="INSERT INTO EVT_PERSONNEL_EC (MATR,CODE_TERM,CODE_MACH,CODE_OF,CODE_OPER,"+
                 "CODE_TACH,CODE_ARTI,DATE_DEBU_PERS,DATE_DEBU_PROD,COEF_QUAN_UNIT,CODE_ETAT_PERS,COEF,"+
                 "QUAN_BONN,QUAN_REBU,DATE_CALE,CODE_EQUI,DATE_CALE_OPER,CODE_EQUI_OPER,DATE_DEBU_AFFE,CADE_THEO,CODE_SECT_ANAL,"+
                 "CODE_SECT_GEOG,CODE_ATEL,CODE_SITE,"+
                 "DELT_HEUR_UTC,CODE_LOCA_PERS,CODE_NOEU_PERS,CODE_LOCA_MACH,CODE_NOEU_MACH) "+
              "VALUES ("+StrqBD(Personnel.PERMatr)+
                 ","+Str(Terminal.TERCodeTerm)+
                 ","+StrqBD(Machine.MACCodeMach)+
                 ","+StrqBD(ChamCleVide)+
                 ","+StrqBD(ChamCleVide)+
                 ","+StrqBD(CodeTachProd)+
                 ","+StrqBD(ChamCleVide)+
                 ","+FormaterTempsBDUTC(DateActuelle)+
                 ","+FormaterTempsBDUTC(DateActuelle)+
                 ",1"+
                 ","+StrqBD(LitConstanteSite("EtatProduction",Site.SITIndice))+
                 ","+Str(NombActi+1)+
                 ",0,0"+
                 ","+FormaterTempsBDOLD(Machine.MACDateCale)+
                 ","+StrqBD(Machine.MACCodeEqui)+
                 ","+FormaterTempsBDOLD(Personnel.PERDateCale)+
                 ","+StrqBD(Personnel.PERCodeEqui)+
                 ","+FormaterTempsBDUTC(DateActuelle)+
                 ",0"+
                 ","+StrqBD(Machine.MACCodeSectAnal)+
                 ","+StrqBD(Machine.MACCodeSectGeog)+
                 ","+StrqBD(Machine.MACCodeAtel)+
                 ","+StrqBD(Machine.MACCodeSite)+
                 ","+Str(DeltaHeureUTC)+
                 ","+StrqBD(Personnel.PERCodeLocaPers)+
                 ","+StrqBD(Personnel.PERCodeNoeuPers)+
                 ","+StrqBD(Machine.MACCodeLocaMach)+
                 ","+StrqBD(Machine.MACCodeNoeuMach)+")";
         Rep:=ExecuteRequeteSQL(Req);
         Fermeture:=FermeReponseSQL(Rep);













































      End If;

      //---- Message de fin du scénario

      MessageFin1:=GetMessage("S_GENE_MESSFINAFF_1",Machine.MACCodeMachSite);
      MessageFin2:=GetMessage("S_GENE_MESSFINAFF_2",Machine.MACCodeMachSite);

   End If;

   //---- Mise à jour de la table Machine pour l'affichage par défaut
   Req:="UPDATE TERMINAL "+
        "SET CODE_MACH_DEFA="+StrqBD(Machine.MACCodeMach)+
        " WHERE CODE_TERM="+Str(Terminal.TERCodeTerm);
   Rep:=ExecuteRequeteSQL(Req);
   Fermeture:=FermeReponseSQL(Rep);
   Terminal.TERCodeMachDefa:=Machine.MACCodeMach;

   //---------------------------------------------------------------
   //   FIN DES ENREGISTREMENTS
   //---------------------------------------------------------------


   LibereVerrouEnreg(NumeTerminal);
If(Autorise=True)Then
   //---- Affichage du Message de Fin
   EcritMessageTempo(Terminal,Personnel.PERNom+" "+Personnel.PERPren,MessageFin1,Personnel.PERNom,MessageFin2);
End If;
     // EcritMessageTempo(Terminal,Personnel.PERNom+" "+Personnel.PERPren,"vous n'êtes pas autorisé ",Machine.MACCodeMach,"");
If MachineVide=False Then
If DejaAffecte=True Then
                   //  EcritMessageErreur(" -----> déja affecter            True "+NomMachine);



                     MatrPers        :=StrqBD(Personnel.PERMatr);
                        NomPers         :=StrqBD(Personnel.PERNom);
                        PrePers         :=StrqBD(Personnel.PERPren);
                        BadgePers       :=StrqBD(Personnel.PERCodeBadg);
      
                        Valeur  := ExtraitChainePosLong(MatrPers,5,6);
      
                        TempsFormate := FormaterTemps ( "%Y-%m-%d %H:%M:%S", TempsSysteme );

                         Req:="INSERT INTO UN_QK_CLOCKING(CLOCKINGDATE,EMPLOYEEIDNUMBER,EMPLOYEESURNAME,EMPLOYEEFIRSTNAME,EMPLOYEEBADGECODE) VALUES ('"+TempsFormate +"','"+Valeur +"',"+NomPers+","+PrePers+","+BadgePers+")";
                        MatrPers:="";
                        Valeur:=""; 
                        TempsFormate :=""; 
                        NomPers:="";
                        PrePers:=""; 
                        BadgePers:="";         
                 
                       Rep:=ExecuteRequeteSQL(Req);
                       Fermeture:=FermeReponseSQL(Rep);
                  //Affectation_UO(Personnel.PERMatr,Personnel.PERNom,Personnel.PERPren,Machine.MACCodeSite,Machine.MACCodeMach);
                        NombReponseEVT:=0;

                      //Else             
                             DesAffectation_UO(Personnel.PERMatr,Personnel.PERNom,Personnel.PERPren,CodeSiteMachine,NomMachine); 
                  NomMachine:="";


Else 
                  //EcritMessageErreur(" ----->             False ");

                  //---------------------------------------------------------------------------------
                        //   DEBUT DES ENREGISTREMENTS POINTAGE AFFECTATION Dans la table de connecteur DéV PAR MAGRAOUI LE 26/12/2017
                        //---------------------------------------------------------------------------------
     
                  //   Verification de la persion si l'existe //
      If(NombReponseEVT=0) Then

EcritMessageErreur(" ----->       NombReponseEVT=0      /////////////////////////////////// ");
                  If(Autorise=True)Then
EcritMessageErreur(" ----->       If(Autorise=True)Then      /////////////////////////////////// ");
                                          MatrPers        :=StrqBD(Personnel.PERMatr);
                                          NomPers         :=StrqBD(Personnel.PERNom);
                                          PrePers         :=StrqBD(Personnel.PERPren);
                                          BadgePers       :=StrqBD(Personnel.PERCodeBadg);
      
                                          Valeur  := ExtraitChainePosLong(MatrPers,5,6);
                                          TempsFormate := FormaterTemps ( "%Y-%m-%d %H:%M:%S", TempsSysteme );

                                           Req:="INSERT INTO UN_QK_CLOCKING(CLOCKINGDATE,EMPLOYEEIDNUMBER,EMPLOYEESURNAME,EMPLOYEEFIRSTNAME,EMPLOYEEBADGECODE) VALUES ('"+TempsFormate +"','"+Valeur +"',"+NomPers+","+PrePers+","+BadgePers+")";
                                          MatrPers:="";
                                          Valeur:=""; 
                                          TempsFormate :=""; 
                                          NomPers:="";
                                          PrePers:=""; 
                                          BadgePers:="";         
                 
                                         Rep:=ExecuteRequeteSQL(Req);
                                         Fermeture:=FermeReponseSQL(Rep);
                                    Affectation_UO(Personnel.PERMatr,Personnel.PERNom,Personnel.PERPren,CodeSiteMachine,NomMachine);
                                          NombReponseEVT:=0;

                                                          //Else             
                                         //      AffDes_UO(Personnel.PERMatr,Personnel.PERNom,Personnel.PERPren,Machine.MACCodeSite,Machine.MACCodeMach);         
                  End If;
Else             
           AffDes_UO(Personnel.PERMatr,Personnel.PERNom,Personnel.PERPren,Machine.MACCodeSite,Machine.MACCodeMach);         

 
      End If;


End If;

End If;

  End If; 
 Until FinSaisie=True;
 //---- Affichage du message par défaut
 EcritMessageDefaut(Terminal);
End  UN_AffDesMaRes_TR;

</body>
</html>


